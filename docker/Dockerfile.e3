# e3 - East Execution Engine (BSL 1.1 + AGPL-3.0)
# Full platform with Node.js + Python runtimes for durable execution
#
# License: Contains BSL 1.1 components - production use requires commercial license
# See: https://github.com/elaraai/e3/blob/main/LICENSE.md
#
# Usage:
#   docker build -f Dockerfile.e3 -t ghcr.io/elaraai/e3 .
#   docker run --rm -v $(pwd):/workspace ghcr.io/elaraai/e3 e3 run my-pipeline

FROM node:22-slim AS base

LABEL org.opencontainers.image.source="https://github.com/elaraai/east-plugin"
LABEL org.opencontainers.image.description="e3 - East Execution Engine (BSL 1.1 + AGPL-3.0)"
LABEL org.opencontainers.image.licenses="BSL-1.1 AND AGPL-3.0"

# Build args for package versions (queried from npm in workflow)
ARG EAST_VERSION
ARG EAST_NODE_STD_VERSION
ARG EAST_NODE_IO_VERSION
ARG EAST_NODE_CLI_VERSION
ARG EAST_UI_VERSION
ARG E3_VERSION
ARG E3_TYPES_VERSION
ARG E3_CORE_VERSION
ARG E3_CLI_VERSION
ARG E3_API_CLIENT_VERSION
ARG E3_API_SERVER_VERSION

# Pass build args as environment variables for install script
ENV EAST_VERSION=${EAST_VERSION:-latest}
ENV EAST_NODE_STD_VERSION=${EAST_NODE_STD_VERSION:-latest}
ENV EAST_NODE_IO_VERSION=${EAST_NODE_IO_VERSION:-latest}
ENV EAST_NODE_CLI_VERSION=${EAST_NODE_CLI_VERSION:-latest}
ENV EAST_UI_VERSION=${EAST_UI_VERSION:-latest}
ENV E3_VERSION=${E3_VERSION:-latest}
ENV E3_TYPES_VERSION=${E3_TYPES_VERSION:-latest}
ENV E3_CORE_VERSION=${E3_CORE_VERSION:-latest}
ENV E3_CLI_VERSION=${E3_CLI_VERSION:-latest}
ENV E3_API_CLIENT_VERSION=${E3_API_CLIENT_VERSION:-latest}
ENV E3_API_SERVER_VERSION=${E3_API_SERVER_VERSION:-latest}

# Install system dependencies including Python
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install uv for Python package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Create Python virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Set working directory
WORKDIR /workspace

# Copy and run install script (Node.js + Python)
COPY docker/install-packages.sh /tmp/install-packages.sh
RUN chmod +x /tmp/install-packages.sh && \
    /tmp/install-packages.sh && \
    rm /tmp/install-packages.sh

# Create compile environment for single-file type-checking
RUN mkdir -p /compile && \
    ln -s /usr/local/lib/node_modules /compile/node_modules && \
    echo '{"compilerOptions":{"target":"esnext","module":"nodenext","strict":true,"skipLibCheck":true,"noEmit":true}}' > /compile/tsconfig.json

# Create e3 data directory
RUN mkdir -p /root/.e3

# Default command
CMD ["bash"]

# East Node Runtime (AGPL-3.0)
# Node.js runtime for East programs with platform functions
#
# Usage:
#   docker build -f Dockerfile.east-node -t ghcr.io/elaraai/east-node .
#   docker run --rm -v $(pwd):/workspace ghcr.io/elaraai/east-node npx @elaraai/east-node-cli run program.east

FROM node:22-slim AS base

LABEL org.opencontainers.image.source="https://github.com/elaraai/east-plugin"
LABEL org.opencontainers.image.description="East Node.js Runtime - AGPL-3.0"
LABEL org.opencontainers.image.licenses="AGPL-3.0"

# Build args for package versions (queried from npm in workflow)
ARG EAST_VERSION
ARG EAST_NODE_STD_VERSION
ARG EAST_NODE_IO_VERSION
ARG EAST_NODE_CLI_VERSION
ARG EAST_UI_VERSION

# Pass build args as environment variables for install script
ENV EAST_VERSION=${EAST_VERSION:-latest}
ENV EAST_NODE_STD_VERSION=${EAST_NODE_STD_VERSION:-latest}
ENV EAST_NODE_IO_VERSION=${EAST_NODE_IO_VERSION:-latest}
ENV EAST_NODE_CLI_VERSION=${EAST_NODE_CLI_VERSION:-latest}
ENV EAST_UI_VERSION=${EAST_UI_VERSION:-latest}

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy and run install script (Node.js only)
COPY docker/install-packages.sh /tmp/install-packages.sh
RUN chmod +x /tmp/install-packages.sh && \
    /tmp/install-packages.sh --node-only && \
    rm /tmp/install-packages.sh

# Create compile environment for single-file type-checking
RUN mkdir -p /compile && \
    ln -s /usr/local/lib/node_modules /compile/node_modules && \
    echo '{"compilerOptions":{"target":"esnext","module":"nodenext","strict":true,"skipLibCheck":true,"noEmit":true}}' > /compile/tsconfig.json

# Default command
CMD ["bash"]

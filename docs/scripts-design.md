# Scripts Design

## Scope Separation

There are three distinct scopes for installation/updates:

| Scope | Purpose | Location | Examples |
|-------|---------|----------|----------|
| **Global** | CLIs installed on user's machine | `east-plugin/scripts/` | `e3`, `east-node`, `east-py` CLIs |
| **Project** | Dependencies for a specific project | Generated in each project | `npm ci`, `uv sync`, `@elaraai/*` packages |
| **Docker** | Packages in container images | `docker/` directory | `install-packages.sh` |

### Global Scripts (this repo)
- Install/update CLIs that live in `~/.nvm/`, `~/.local/bin/`, etc.
- Run once per machine, not per project

### Project Scripts (generated by `project/new.sh`)
- Makefile with `install`, `refresh`, `build` targets
- `scripts/refresh-elaraai.sh` for updating `@elaraai/*` npm packages
- Operate on project's `node_modules/`, `.venv/`, `package.json`, `pyproject.toml`

### Docker Scripts
- `install-packages.sh` used during `docker build`
- Installs everything needed in the container image

## Directory Structure

```
scripts/
├── lib/
│   ├── common.sh                 # Logging, prompts, nvm sourcing
│   └── docker-fallback.sh        # Docker/local CLI fallback pattern
│
├── global/                       # GLOBAL SCOPE: User's machine
│   ├── install.sh                # Install CLIs from npm/PyPI (end users)
│   ├── install-dev.sh            # Clone & build from source (contributors)
│   ├── update.sh                 # Update CLIs from npm/PyPI
│   └── update-dev.sh             # Pull & rebuild source repos
│
├── project/                      # PROJECT SCOPE: Scaffolding
│   ├── new.sh                    # Create new East/e3 project
│   └── templates/
│       ├── package.json.tmpl
│       ├── tsconfig.json
│       ├── eslint.config.js
│       ├── Makefile.tmpl         # Project-level install/refresh targets
│       ├── gitignore
│       ├── pyproject.toml.tmpl
│       ├── refresh-elaraai.sh    # Project-level npm package refresh
│       └── src/
│           ├── main.ts.tmpl
│           ├── index.ts
│           └── index.spec.ts
│
├── e3/                           # E3 CLI wrappers (with Docker fallback)
│   ├── init.sh                   # → commands/e3-init.md
│   ├── start.sh                  # → commands/e3-start.md
│   ├── run.sh                    # → commands/e3-run.md
│   ├── watch.sh                  # → commands/e3-watch.md
│   ├── status.sh                 # → commands/e3-status.md
│   ├── logs.sh                   # → commands/e3-logs.md
│   ├── get.sh                    # → commands/e3-get.md
│   └── set.sh                    # → commands/e3-set.md
│
└── east/                         # East CLI wrappers (with Docker fallback)
    └── compile.sh                # → commands/compile.md

docker/                           # DOCKER SCOPE: Container images
├── Dockerfile.e3                 # Full e3 image (Node + Python)
├── Dockerfile.east-node          # East-node only image
├── docker-compose.yml
├── install-packages.sh           # Called by Dockerfiles during build
└── test-install.sh               # Test install scripts in fresh container
```

## Command → Script Mapping

| Command | Script | Docker Fallback |
|---------|--------|-----------------|
| `/e3-init` | `scripts/e3/init.sh` | `ghcr.io/elaraai/e3` |
| `/e3-start` | `scripts/e3/start.sh` | `ghcr.io/elaraai/e3` |
| `/e3-run` | `scripts/e3/run.sh` | `ghcr.io/elaraai/e3` |
| `/e3-watch` | `scripts/e3/watch.sh` | `ghcr.io/elaraai/e3` |
| `/e3-status` | `scripts/e3/status.sh` | `ghcr.io/elaraai/e3` |
| `/e3-logs` | `scripts/e3/logs.sh` | `ghcr.io/elaraai/e3` |
| `/e3-get` | `scripts/e3/get.sh` | `ghcr.io/elaraai/e3` |
| `/e3-set` | `scripts/e3/set.sh` | `ghcr.io/elaraai/e3` |
| `/compile` | `scripts/east/compile.sh` | `ghcr.io/elaraai/east-node` |

## Generated Project Structure

When `project/new.sh` runs, it creates:

```
my-project/
├── package.json                  # @elaraai/* as dependencies
├── pyproject.toml                # east-py-* from git
├── Makefile                      # Project-level targets:
│   │                             #   make install  - npm ci + uv sync
│   │                             #   make refresh  - update @elaraai/* to latest
│   │                             #   make build    - tsc
│   │                             #   make start    - package + deploy + run
├── scripts/
│   └── refresh-elaraai.sh        # Update @elaraai/* npm packages
├── src/
│   ├── main.ts
│   ├── index.ts
│   └── __tests__/
└── tests/
```

## Usage

### Global: Install CLIs (once per machine)

```bash
# End users: Install from npm/PyPI
curl -fsSL https://raw.githubusercontent.com/elaraai/east-plugin/main/scripts/global/install.sh | bash

# Contributors: Clone & build from source
curl -fsSL https://raw.githubusercontent.com/elaraai/east-plugin/main/scripts/global/install-dev.sh | bash
```

### Global: Update CLIs

```bash
# End users: Update from npm/PyPI
curl -fsSL https://raw.githubusercontent.com/elaraai/east-plugin/main/scripts/global/update.sh | bash

# Contributors: Pull & rebuild repos
curl -fsSL https://raw.githubusercontent.com/elaraai/east-plugin/main/scripts/global/update-dev.sh | bash
```

### Project: Create New Project

```bash
curl -fsSL https://raw.githubusercontent.com/elaraai/east-plugin/main/scripts/project/new.sh | bash
# or
./scripts/project/new.sh my-project
```

### Project: Install/Update Dependencies (inside project)

```bash
cd my-project

# Install project dependencies (npm + python)
make install

# Update @elaraai/* packages to latest beta
make refresh

# Or directly:
npm ci && uv sync                    # install
./scripts/refresh-elaraai.sh         # refresh npm
make refresh-python                  # refresh python
```

## Shared Libraries

### `lib/common.sh`

**Key fixes for `curl | bash` compatibility:**
1. `read` from `/dev/tty` not stdin (stdin is the script when piped)
2. Use `case` instead of `[[ =~ ]]` for regex (more portable)

```bash
#!/usr/bin/env bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }

confirm() {
    if [ "${AUTO_YES:-false}" = true ]; then return 0; fi
    # Read from /dev/tty to work with curl | bash (stdin is the script)
    read -p "$1 [y/N] " -n 1 -r < /dev/tty
    echo
    # Use case instead of [[ =~ ]] for better compatibility
    case "$REPLY" in [Yy]) return 0 ;; *) return 1 ;; esac
}

run_as_root() {
    if [ "$(id -u)" -eq 0 ]; then "$@"
    elif command -v sudo &> /dev/null; then sudo "$@"
    else log_error "Need root but no sudo"; return 1; fi
}

source_nvm() {
    export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
}

has_command() { command -v "$1" &> /dev/null; }
```

### `lib/docker-fallback.sh`

```bash
#!/usr/bin/env bash

run_cli() {
    local cli="$1" image="$2"; shift 2
    if command -v "$cli" &> /dev/null; then
        "$cli" "$@"
    elif command -v docker &> /dev/null; then
        docker run --rm -v "$(pwd):/workspace" -v "${HOME}/.e3:/root/.e3" -w /workspace "$image" "$cli" "$@"
    else
        echo "Error: Neither '$cli' nor Docker installed." >&2; exit 1
    fi
}

run_cli_interactive() {
    local cli="$1" image="$2"; shift 2
    if command -v "$cli" &> /dev/null; then
        "$cli" "$@"
    elif command -v docker &> /dev/null; then
        docker run --rm -it -v "$(pwd):/workspace" -v "${HOME}/.e3:/root/.e3" -w /workspace "$image" "$cli" "$@"
    else
        echo "Error: Neither '$cli' nor Docker installed." >&2; exit 1
    fi
}
```

## E3 Wrapper Scripts

Each becomes a 3-liner:

```bash
#!/usr/bin/env bash
source "$(dirname "$0")/../lib/docker-fallback.sh"
run_cli e3 ghcr.io/elaraai/e3 start "$@"
```

## Command Files

Update paths in `commands/*.md`:

```markdown
allowed-tools: ["Bash(${CLAUDE_PLUGIN_ROOT}/scripts/e3/start.sh)"]
```

## Template Files

Templates use `${VAR}` syntax, processed with `envsubst`:

- `.tmpl` extension = needs variable substitution
- No extension = copy as-is

Variables available:
- `${PROJECT_NAME}` - kebab-case name (e.g., `my-project`)
- `${PACKAGE_NAME}` - npm scope (e.g., `@elaraai/my-project`)
- `${DISPLAY_NAME}` - Title Case (e.g., `My Project`)

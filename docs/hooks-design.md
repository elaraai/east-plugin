# East Plugin Hooks Design

## Problem Statement

When agents use East skills, they:
1. Read `SKILL.md` which provides high-level guidance
2. But `SKILL.md` can't contain all detailed API types and examples (too long)
3. Result: Agents make mistakes because they lack detailed API info

Additionally:
- Developers working on East projects don't know East skills are available
- No proactive engagement when Claude opens in an East project

## Goals

1. **Project Detection**: When Claude opens in a project with East dependencies, proactively inform about available skills
2. **Contextual Doc Injection**: When users ask about East topics, search and inject relevant docs from `reference/api.md` and `reference/examples.md`
3. **Skill-Scoped**: Only inject docs relevant to the specific East package being used

## Available Hook Events

| Hook | When it Fires | Can Inject Context? | Use Case |
|------|---------------|---------------------|----------|
| `SessionStart` | Claude opens/resumes | Yes (`additionalContext`) | Detect East project, announce skills |
| `UserPromptSubmit` | User sends message | Yes (`additionalContext`) | Search docs based on prompt |
| `PostToolUse` | After tool executes | Yes (`additionalContext`) | Inject docs after code is written |
| `PreToolUse` | Before tool executes | Limited (modify input) | Not useful for our case |

## Plugin Hooks vs Skill Hooks

Claude Code supports two types of hooks:

| Aspect | Plugin Hooks | Skill Hooks |
|--------|--------------|-------------|
| **Location** | `hooks/hooks.json` in plugin root | `SKILL.md` frontmatter (YAML) |
| **Supported Events** | All 10 types | Only `PreToolUse`, `PostToolUse`, `Stop` |
| **Scope** | Global while plugin enabled | Only during skill execution |
| **Lifecycle** | Persist while plugin is enabled | Auto-cleanup when skill ends |

**Why we use plugin hooks**: Our design requires `SessionStart` and `UserPromptSubmit` events, which are only available in plugin hooks. Skill hooks don't support these events.

**Potential skill hook addition**: We could add `PostToolUse` hooks to individual East skill `SKILL.md` files for code validation, scoped to when that skill is active. This is optional and separate from the plugin-level hooks.

## Proposed Architecture

```
east-plugin/
├── build/
│   └── index.json              # Pre-built search index (generated by CI, gitignored)
├── hooks/
│   ├── hooks.json              # Plugin hook configuration
│   ├── src/
│   │   ├── session-start.ts    # Detect East project on startup
│   │   ├── prompt-submit.ts    # Search docs based on user prompt
│   │   └── lib/
│   │       ├── search.ts       # Search index management
│   │       └── routing.ts      # Skill routing logic
│   ├── dist/                   # Compiled JS (gitignored)
│   └── tsconfig.json           # TypeScript config for hooks
├── skills/
│   ├── east/
│   │   ├── SKILL.md
│   │   └── reference/
│   │       ├── api.md
│   │       └── examples.md
│   ├── east-node-std/
│   │   └── ...
│   └── ...
├── scripts/
│   ├── lib/                    # Shared bash libraries
│   │   ├── common.sh           # Logging, prompts, nvm sourcing
│   │   └── docker-fallback.sh  # Docker/local CLI fallback
│   ├── global/                 # Global install scripts
│   │   ├── install.sh
│   │   ├── install-dev.sh
│   │   ├── update.sh
│   │   └── update-dev.sh
│   ├── project/                # Project scaffolding
│   │   ├── east.sh             # AGPL East project
│   │   └── e3.sh               # BSL e3 project
│   ├── e3/                     # e3 CLI wrappers
│   │   ├── init.sh, start.sh, run.sh, watch.sh
│   │   └── status.sh, logs.sh, get.sh, set.sh
│   └── east/                   # East CLI wrappers
│       └── compile.sh
├── docker/
│   ├── Dockerfile.east-node
│   ├── Dockerfile.e3
│   ├── install-packages.sh
│   └── test-install.sh
├── tests/                      # Test scripts
│   ├── test-all.sh
│   ├── test-scripts-syntax.sh
│   ├── test-project-east.sh
│   ├── test-project-e3.sh
│   └── test-docker-builds.sh
├── tsconfig.json               # Root TypeScript config
├── eslint.config.js            # ESLint config
└── package.json                # Dependencies and scripts
```

## Hook 1: SessionStart (Project Detection)

**Purpose**: When Claude opens, check if the project uses East and announce available skills.

**Trigger**: `SessionStart` with matcher `startup`

**Logic**:
```
1. Read $CLAUDE_PROJECT_DIR/package.json
2. Check dependencies for @elaraai/* packages
3. Map packages to skills:
   - @elaraai/east → east skill
   - @elaraai/east-node-std → east-node-std skill
   - @elaraai/east-node-io → east-node-io skill
   - @elaraai/east-py-datascience → east-py-datascience skill
   - @elaraai/east-ui → east-ui skill
   - @elaraai/e3 → e3 skill
4. Output additionalContext with:
   - Which East packages are installed
   - Which skills are available
   - Suggestion to use /east:<skill> for help
```

**Example Output**:
```
This project uses East packages:
- @elaraai/east (core language)
- @elaraai/east-node-std (Node.js platform functions)
- @elaraai/e3 (execution engine)

Available skills: /east:east, /east:east-node-std, /east:e3

Tip: Use these skills when writing East code for accurate API guidance.
```

## Hook 2: UserPromptSubmit (Doc Search)

**Purpose**: When user asks a question in an East project, search reference docs and inject relevant content.

**Trigger**: `UserPromptSubmit` (no matcher, fires on all prompts)

**Key Design Decision**: Don't rely on keyword detection (e.g., checking if prompt contains "east"). Users often ask questions like "how do I sum an array?" without mentioning East. Instead, use **full-text search** against the index with the entire prompt.

**Logic**:
```
1. Check if this is an East project (cached from SessionStart)
   - If not an East project: exit 0 immediately (no injection)
2. Read prompt from stdin JSON
3. Search the pre-built index with the FULL PROMPT text
   - MiniSearch handles tokenization and relevance scoring
   - Filter results to skills matching project dependencies
4. Check result quality:
   - If top result score < threshold (e.g., 5.0): exit 0 (no injection)
   - Low scores mean the prompt isn't relevant to indexed content
5. If good matches found:
   - Take top 3-5 results
   - Format and inject as additionalContext
6. Exit 0
```

**Why Full-Text Search Works Better**:

| User Prompt | Keyword Detection | Full-Text Search |
|-------------|-------------------|------------------|
| "How do I sum an array?" | ❌ No "east" keyword | ✅ Matches "array", "sum" in docs |
| "What's the syntax for creating a function?" | ❌ No "east" keyword | ✅ Matches "function", "syntax" in docs |
| "How do I read a file?" | ❌ No "east" keyword | ✅ Matches FileSystem docs |
| "What's the weather today?" | ❌ Correctly skips | ✅ Low score, correctly skips |

**Search Flow**:
```
User: "How do I iterate over an array and sum the values?"
                    │
                    ▼
         ┌─────────────────────┐
         │  Full-text search   │
         │  query: entire      │
         │  prompt text        │
         └─────────────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  MiniSearch scores  │
         │  all indexed docs   │
         └─────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────┐
    │  Results (sorted by score):   │
    │  1. array-operations (12.5)   │
    │  2. collection-examples (8.2) │
    │  3. integer-math (3.1)        │
    └───────────────────────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  Inject top 2 docs  │
         │  (score > 5.0)      │
         └─────────────────────┘
```

**Example Output**:
```
<east-reference skill="east">

## Array Operations

Arrays support aggregation methods:
- `arr.sum()` - Sum all numeric elements
- `arr.reduce(fn, init)` - Reduce to single value
- `arr.forEach(fn)` - Iterate with side effects

### Example: Sum Array
```typescript
const sumArray = East.function([ArrayType(IntegerType)], IntegerType, ($, arr) => {
    $.return(arr.sum());
});
```

</east-reference>
```

## Hook 3: PostToolUse (Code Validation) - Optional

**Purpose**: After code is written, check for common East mistakes and inject corrections.

**Trigger**: `PostToolUse` with matcher `Edit|Write`

**Logic**:
```
1. Check if edited file contains East imports
2. Scan for common mistakes:
   - Using East.IntegerType instead of IntegerType
   - Missing $.return() in function body
   - Wrong type for bigint (should use IntegerType)
3. If mistakes found, inject correction hints
```

**Note**: This is lower priority than SessionStart and UserPromptSubmit.

## Configuration: hooks/hooks.json

```json
{
  "description": "East plugin hooks for project detection and documentation injection",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup|resume",
        "hooks": [
          {
            "type": "command",
            "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/dist/session-start.js",
            "timeout": 10
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/dist/prompt-submit.js",
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

## Environment Variables Available

| Variable | Available In | Description |
|----------|--------------|-------------|
| `CLAUDE_PROJECT_DIR` | All hooks | Project directory Claude is running in |
| `CLAUDE_PLUGIN_ROOT` | Plugin hooks | Root directory of the plugin |
| `CLAUDE_ENV_FILE` | SessionStart only | File to write env vars for session |

## Output Format

All hooks output JSON to inject context:

```json
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart|UserPromptSubmit|PostToolUse",
    "additionalContext": "Content to inject into Claude's context"
  }
}
```

Or plain text (for simpler cases):
```
This text is automatically added as context.
```

## Skill-to-Package Mapping

```json
{
  "@elaraai/east": "east",
  "@elaraai/east-node-std": "east-node-std",
  "@elaraai/east-node-io": "east-node-io",
  "@elaraai/east-py-datascience": "east-py-datascience",
  "@elaraai/east-ui": "east-ui",
  "@elaraai/e3": "e3",
  "@elaraai/e3-cli": "e3",
  "@elaraai/e3-core": "e3",
  "@elaraai/e3-types": "e3"
}
```

## Structured Reference Documentation

### Problem with Current Structure

The current `reference/api.md` and `reference/examples.md` files are **monolithic blobs** that don't index well:

| File | Lines | Problem |
|------|-------|---------|
| `east/reference/api.md` | 827 | Too large, sections blur together |
| `east/reference/examples.md` | 804 | Hard to match specific topics |
| `east-py-datascience/reference/examples.md` | 1677 | Way too large for good search |

When searching "how do I sum an array?", the entire Array section might match, but we can't easily extract just the relevant `.sum()` documentation.

### Proposed Solution: Granular Files with YAML Frontmatter + Testable Examples

Instead of monolithic files, use **smaller topic-focused files** with:
1. Structured YAML frontmatter for indexing
2. **Separate `.ts` example files** that can be compiled and tested

```
skills/east/
├── SKILL.md                          # Overview (<500 lines)
└── reference/
    ├── types/
    │   ├── primitives.md             # Integer, Float, String, Boolean, etc.
    │   ├── primitives.example.ts     # Testable examples
    │   ├── collections.md            # Array, Set, Dict, Ref
    │   ├── collections.example.ts
    │   └── ...
    ├── functions/
    │   ├── defining.md               # East.function, East.asyncFunction
    │   ├── defining.example.ts
    │   └── ...
    ├── expressions/
    │   ├── arithmetic.md
    │   ├── arithmetic.example.ts
    │   └── ...
    └── examples/                     # Standalone runnable examples
        ├── hello-world.ts
        ├── sum-array.ts
        ├── file-processing.ts
        └── ...
```

**Benefits of `.ts` example files:**

| Aspect | Markdown Code Blocks | Separate `.ts` Files |
|--------|---------------------|----------------------|
| **Syntax verification** | None | TypeScript compiler |
| **Runtime verification** | None | Can run and test output |
| **CI integration** | Cannot automate | `npm run test:examples` |
| **IDE support** | Limited | Full IntelliSense |
| **Import verification** | Cannot verify | Real imports checked |
| **Version drift** | Examples can rot | Compilation catches issues |

**Example file structure:**

```typescript
// reference/expressions/collections.example.ts
import { East, IntegerType, ArrayType } from "@elaraai/east";

// Example: Sum an array of integers
export const sumArray = East.function(
    [ArrayType(IntegerType)],
    IntegerType,
    ($, arr) => {
        $.return(arr.sum());
    }
);

// Example: Filter positive numbers
export const filterPositive = East.function(
    [ArrayType(IntegerType)],
    ArrayType(IntegerType),
    ($, arr) => {
        $.return(arr.filter(x => x.gt(0n)));
    }
);
```

**Markdown references the examples:**

```markdown
---
title: Array Operations
keywords: [array, ArrayType, sum, map, filter, reduce]
summary: Operations for working with arrays
examples: [collections.example.ts]
---

## Array Operations

### Aggregation

| Method | Description |
|--------|-------------|
| `arr.sum()` | Sum all numeric elements |

See [collections.example.ts](./collections.example.ts) for working examples.
```

**CI verification:**

Example files are verified by TypeScript compilation. The build process will fail if any example has type errors or invalid imports.

### YAML Frontmatter for Each File

Each reference file includes structured metadata for indexing:

```yaml
---
title: Array Operations
keywords:
  - array
  - ArrayType
  - sum
  - map
  - filter
  - reduce
  - forEach
  - length
  - slice
  - concat
  - includes
  - find
  - sort
related:
  - types/collections
  - expressions/control-flow
summary: >
  Operations for working with arrays including iteration (map, forEach),
  transformation (filter, sort), aggregation (sum, reduce), and access
  (slice, find, includes).
---

## Array Operations

Arrays (`ArrayType(T)`) support rich operations for processing collections.

### Aggregation

| Method | Signature | Description |
|--------|-----------|-------------|
| `sum()` | `arr.sum(): IntegerExpr \| FloatExpr` | Sum all numeric elements |
| `reduce()` | `arr.reduce(fn, init)` | Reduce to single value |
| `count()` | `arr.count(): IntegerExpr` | Number of elements |

### Example: Sum Array

```typescript
const sumArray = East.function(
    [ArrayType(IntegerType)],
    IntegerType,
    ($, arr) => {
        $.return(arr.sum());
    }
);
```

...
```

### Benefits of This Structure

| Aspect | Monolithic (api.md) | Granular (topic files) |
|--------|---------------------|------------------------|
| **Search precision** | Returns entire section | Returns specific topic |
| **Index size** | Large sections, fuzzy matches | Small docs, precise matches |
| **Keyword coverage** | Implicit in content | Explicit in frontmatter |
| **Human readability** | Scroll to find topic | Navigate to specific file |
| **Maintenance** | Edit large file | Edit focused file |
| **Token efficiency** | May inject irrelevant content | Inject only relevant topic |

### Indexing Strategy

The build-index script extracts from YAML frontmatter in `.md` files and also indexes associated `.example.ts` files:

```typescript
interface IndexedDocument {
  id: string;           // "east:expressions/collections:array-operations"
  skill: string;        // "east"
  path: string;         // "expressions/collections.md"
  title: string;        // "Array Operations"
  keywords: string[];   // ["array", "sum", "map", "filter", ...]
  summary: string;      // "Operations for working with arrays..."
  content: string;      // Markdown content (truncated)
  examples: string[];   // ["collections.example.ts"]
  exampleCode: string;  // Content of example files (for code search)
}
```

**Search matching uses**:
1. `keywords` array (boosted 3x) - explicit terms from frontmatter
2. `title` (boosted 2x) - section heading
3. `summary` (boosted 1.5x) - short description
4. `exampleCode` (boosted 1.2x) - actual TypeScript examples
5. `content` (boosted 1x) - markdown prose

### Migration Path

1. **Phase 1**: Add YAML frontmatter to existing api.md/examples.md sections
2. **Phase 2**: Split large files into topic-focused files
3. **Phase 3**: Update SKILL.md to reference new structure

For Phase 1, we can use `---` markers within existing files:

```markdown
# East API Reference

---
title: East Namespace
keywords: [East.function, East.asyncFunction, East.compile, East.value]
summary: Main entry point for creating East programs
---

## East Namespace

Main entry point for building East programs...

---
title: BlockBuilder Operations
keywords: [$.let, $.const, $.return, $.if, $.while, $.for]
summary: Operations available within function bodies via the $ parameter
---

## BlockBuilder Operations

The first argument ($) in function body provides...
```

This allows incremental migration without breaking existing structure.

## Search Algorithm

We use MiniSearch for full-text search with field boosting, searching **the entire user prompt** against all indexed documents.

### Document Parsing (with YAML frontmatter)

```typescript
import { parse as parseYaml } from 'yaml';

interface DocumentFrontmatter {
  title: string;
  keywords: string[];
  summary?: string;
  related?: string[];
}

interface IndexedDocument {
  id: string;
  skill: string;
  path: string;
  title: string;
  keywords: string[];
  summary: string;
  content: string;
}

function parseDocument(content: string, skillName: string, filePath: string): IndexedDocument[] {
  const docs: IndexedDocument[] = [];

  // Split on YAML frontmatter markers (--- at start of line)
  const sections = content.split(/^---$/m).filter(s => s.trim());

  for (let i = 0; i < sections.length; i += 2) {
    // Even indices are YAML frontmatter, odd indices are content
    if (i + 1 >= sections.length) break;

    try {
      const frontmatter = parseYaml(sections[i]) as DocumentFrontmatter;
      const docContent = sections[i + 1].trim();

      const id = `${skillName}:${filePath}:${frontmatter.title.toLowerCase().replace(/\s+/g, '-')}`;

      docs.push({
        id,
        skill: skillName,
        path: filePath,
        title: frontmatter.title,
        keywords: frontmatter.keywords || [],
        summary: frontmatter.summary || '',
        content: docContent.slice(0, 2000)  // Truncate for index
      });
    } catch {
      // Skip malformed sections
    }
  }

  return docs;
}
```

### MiniSearch Configuration

```typescript
import MiniSearch from 'minisearch';

function createIndex(sections: Section[]): MiniSearch {
  const index = new MiniSearch({
    fields: ['header', 'content', 'keywords'],
    storeFields: ['id', 'source', 'header', 'content'],
    searchOptions: {
      boost: { header: 3, keywords: 2, content: 1 },
      fuzzy: 0.2,
      prefix: true
    }
  });

  index.addAll(sections.map(s => ({
    ...s,
    keywords: s.keywords.join(' ')
  })));

  return index;
}

function search(index: MiniSearch, query: string, skills?: string[]): SearchResult[] {
  return index.search(query, {
    limit: 5,
    filter: skills ? (result) => skills.some(s => result.id.startsWith(s + ':')) : undefined
  });
}
```

### Format Output

```typescript
function formatResults(results: SearchResult[], maxChars = 2000): string {
  const output: string[] = [];
  let chars = 0;

  for (const result of results) {
    let text = result.content;
    if (text.length > 800) {
      text = text.slice(0, 800) + '\n... [truncated]';
    }

    const chunk = `### ${result.header}\n${text}`;
    if (chars + chunk.length > maxChars) break;

    output.push(chunk);
    chars += chunk.length;
  }

  return output.length > 0
    ? `## From ${results[0].source}:\n\n${output.join('\n\n')}`
    : '';
}
```

### Example Search

**User prompt**: "How do I iterate over an array and sum values in East?"

**Query terms extracted**:
- `('array', 0.5)`
- `('sum', 0.5)`
- `('iterate', 0.5)`

**Sections matched** (from api.md):
1. "Array Expressions" (score: 1.5) - header contains "array", keywords contain "sum"
2. "BlockBuilder Operations" (score: 0.5) - contains loop/iteration

**Sections matched** (from examples.md):
1. "Collections" (score: 1.0) - contains array examples with sum

**Output injected**:
```markdown
<east-reference>

## From api.md:

### Array Expressions
| Signature | Description |
| `arr.sum(): IntegerExpr \| FloatExpr` | Sum all elements |
| `arr.map(fn): ArrayExpr` | Transform each element |
| `arr.filter(fn): ArrayExpr` | Keep matching elements |
...

## From examples.md:

### Collections
```typescript
// Sum array of integers
const sumArray = East.function([ArrayType(IntegerType)], IntegerType, ($, arr) => {
    $.return(arr.sum());
});
```
...

</east-reference>
```

## Skill Routing

When a user asks a question, we need to determine which skill's docs to search.

### Strategy: Project Dependencies + Query Analysis

```typescript
const PACKAGE_TO_SKILL: Record<string, string> = {
  '@elaraai/east': 'east',
  '@elaraai/east-node-std': 'east-node-std',
  '@elaraai/east-node-io': 'east-node-io',
  '@elaraai/east-py-datascience': 'east-py-datascience',
  '@elaraai/east-ui': 'east-ui',
  '@elaraai/e3': 'e3',
  '@elaraai/e3-cli': 'e3',
  '@elaraai/e3-core': 'e3',
};

const SKILL_KEYWORDS: Record<string, string[]> = {
  'east': ['east.function', 'east.compile', 'type', 'expression', 'integertype', 'arraytype'],
  'east-node-std': ['console', 'filesystem', 'fetch', 'crypto', 'random', 'time', 'path'],
  'east-node-io': ['sql', 'sqlite', 'postgres', 'redis', 'mongodb', 's3', 'ftp', 'xlsx'],
  'east-py-datascience': ['optimize', 'mads', 'optuna', 'xgboost', 'lightgbm', 'torch', 'sklearn', 'shap'],
  'east-ui': ['component', 'button', 'input', 'table', 'chart', 'layout', 'form'],
  'e3': ['e3', 'task', 'pipeline', 'dataflow', 'workspace', 'package'],
};

function determineRelevantSkills(projectDeps: Set<string>, prompt: string): string[] {
  const relevant: string[] = [];
  const promptLower = prompt.toLowerCase();

  // 1. Start with skills matching project dependencies
  for (const [pkg, skill] of Object.entries(PACKAGE_TO_SKILL)) {
    if (projectDeps.has(pkg) && !relevant.includes(skill)) {
      relevant.push(skill);
    }
  }

  // 2. Boost/add skills based on prompt keywords
  for (const [skill, keywords] of Object.entries(SKILL_KEYWORDS)) {
    if (keywords.some(kw => promptLower.includes(kw))) {
      if (!relevant.includes(skill)) {
        relevant.push(skill);
      } else {
        // Move to front (higher priority)
        relevant.splice(relevant.indexOf(skill), 1);
        relevant.unshift(skill);
      }
    }
  }

  // 3. Always include 'east' if any East skill is relevant (it's the foundation)
  if (relevant.length > 0 && !relevant.includes('east')) {
    relevant.push('east');
  }

  return relevant.slice(0, 3); // Limit to top 3 skills
}
```

### Example Routing

| Prompt | Project Deps | Skills Searched |
|--------|--------------|-----------------|
| "How do I create an East function?" | `@elaraai/east` | `east` |
| "How do I read a file?" | `@elaraai/east`, `@elaraai/east-node-std` | `east-node-std`, `east` |
| "How do I query PostgreSQL?" | `@elaraai/east-node-io` | `east-node-io`, `east` |
| "How do I optimize with MADS?" | `@elaraai/east-py-datascience` | `east-py-datascience`, `east` |
| "How do I create a Button?" | `@elaraai/east-ui` | `east-ui`, `east` |
| "How do I run an e3 task?" | `@elaraai/e3` | `e3`, `east` |

## Pre-built Search Index

Instead of parsing docs at runtime, we pre-build a search index at CI time.

### Index Structure

```
east-plugin/
├── build/
│   └── index.json              # Pre-built search index (generated by CI, gitignored)
├── skills/
│   ├── east/
│   │   ├── SKILL.md
│   │   └── reference/
│   │       ├── api.md
│   │       └── examples.md
│   └── ...
├── hooks/
│   └── src/
│       └── lib/
│           └── build-index.ts  # Index builder script
└── ...
```

**Note**: The `build/` directory should be added to `.gitignore` since it contains generated artifacts that are rebuilt by CI.

### Index Format

```json
{
  "version": 1,
  "built": "2024-01-15T10:30:00Z",
  "skills": {
    "east": {
      "sections": [
        {
          "id": "east:api:east-namespace",
          "source": "api.md",
          "header": "East Namespace",
          "content": "Main entry point for building East programs...",
          "keywords": ["east.function", "east.compile", "east.value", "function", "compile"]
        },
        {
          "id": "east:api:blockbuilder",
          "source": "api.md",
          "header": "BlockBuilder Operations",
          "content": "The first argument ($) in function body...",
          "keywords": ["$.let", "$.const", "$.return", "$.if", "variable", "return"]
        }
      ]
    },
    "east-node-std": {
      "sections": [...]
    }
  }
}
```

### Build Script: scripts/build-index.ts

```typescript
#!/usr/bin/env npx tsx
// Run: npx tsx scripts/build-index.ts

import { readFileSync, writeFileSync, readdirSync, existsSync, mkdirSync } from 'fs';
import { join } from 'path';
import { parse as parseYaml } from 'yaml';

const SKILLS_DIR = './skills';
const BUILD_DIR = './build';
const OUTPUT_FILE = `${BUILD_DIR}/index.json`;

interface Frontmatter {
  title: string;
  keywords: string[];
  summary?: string;
}

interface IndexedDocument {
  id: string;
  skill: string;
  path: string;
  title: string;
  keywords: string[];
  summary: string;
  content: string;
}

interface Index {
  version: number;
  built: string;
  documents: IndexedDocument[];
}

function parseDocuments(content: string, skillName: string, filePath: string): IndexedDocument[] {
  const docs: IndexedDocument[] = [];

  // Split on YAML frontmatter markers (--- at start of line)
  const parts = content.split(/^---$/m).filter(s => s.trim());

  for (let i = 0; i < parts.length; i += 2) {
    if (i + 1 >= parts.length) break;

    try {
      const frontmatter = parseYaml(parts[i]) as Frontmatter;
      const docContent = parts[i + 1].trim();

      if (!frontmatter.title || !frontmatter.keywords) continue;

      const id = `${skillName}:${filePath}:${frontmatter.title.toLowerCase().replace(/\s+/g, '-')}`;

      docs.push({
        id,
        skill: skillName,
        path: filePath,
        title: frontmatter.title,
        keywords: frontmatter.keywords,
        summary: frontmatter.summary || '',
        content: docContent.slice(0, 2000)
      });
    } catch {
      // Skip malformed sections
    }
  }

  return docs;
}

function buildIndex(): void {
  const index: Index = {
    version: 1,
    built: new Date().toISOString(),
    documents: []
  };

  const skillDirs = readdirSync(SKILLS_DIR, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name);

  for (const skill of skillDirs) {
    const refDir = join(SKILLS_DIR, skill, 'reference');
    if (!existsSync(refDir)) continue;

    // Index all .md files in reference directory
    const mdFiles = readdirSync(refDir).filter(f => f.endsWith('.md'));

    for (const file of mdFiles) {
      const filePath = join(refDir, file);
      const content = readFileSync(filePath, 'utf-8');
      const docs = parseDocuments(content, skill, file);
      index.documents.push(...docs);
    }

    console.log(`Indexed ${skill}: ${index.documents.filter(d => d.skill === skill).length} documents`);
  }

  if (!existsSync(BUILD_DIR)) {
    mkdirSync(BUILD_DIR, { recursive: true });
  }
  writeFileSync(OUTPUT_FILE, JSON.stringify(index, null, 2));
  console.log(`\nWrote ${OUTPUT_FILE} (${index.documents.length} total documents)`);
}

buildIndex();
```

### GitHub Action Integration

Add to `.github/workflows/update-skills.yml`:

```yaml
      - name: Copy skills
        run: |
          # ... existing copy logic ...

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build search index
        run: npm run build:index

      - name: Clean up source repos
        run: rm -rf .sources
```

### Runtime Search (hooks/src/lib/search.ts)

```typescript
import { readFileSync } from 'fs';
import { join } from 'path';
import MiniSearch from 'minisearch';

interface IndexedDocument {
  id: string;
  skill: string;
  path: string;
  title: string;
  keywords: string[];
  summary: string;
  content: string;
}

interface IndexData {
  version: number;
  built: string;
  documents: IndexedDocument[];
}

interface SearchOptions {
  limit?: number;
  skills?: string[];
  minScore?: number;
}

let searchIndex: MiniSearch<IndexedDocument> | null = null;

export function loadIndex(pluginRoot: string): MiniSearch<IndexedDocument> {
  if (searchIndex) return searchIndex;

  const indexPath = join(pluginRoot, 'build', 'index.json');
  const data: IndexData = JSON.parse(readFileSync(indexPath, 'utf-8'));

  searchIndex = new MiniSearch<IndexedDocument>({
    fields: ['title', 'keywords', 'summary', 'content'],
    storeFields: ['id', 'skill', 'path', 'title', 'summary', 'content'],
    searchOptions: {
      boost: { keywords: 3, title: 2, summary: 1.5, content: 1 },
      fuzzy: 0.2,
      prefix: true
    }
  });

  // Add all documents, converting keywords array to space-separated string
  searchIndex.addAll(data.documents.map(doc => ({
    ...doc,
    keywords: doc.keywords.join(' ')
  })));

  return searchIndex;
}

export function search(query: string, options: SearchOptions = {}) {
  if (!searchIndex) throw new Error('Index not loaded');

  const results = searchIndex.search(query, {
    filter: options.skills
      ? (result) => options.skills!.includes((result as { skill: string }).skill)
      : undefined
  });

  // Filter by minimum score and limit
  const minScore = options.minScore ?? 5.0;
  const limit = options.limit ?? 5;

  return results
    .filter(r => r.score >= minScore)
    .slice(0, limit);
}
```

## Refined Hook Flow

### SessionStart Hook

```
1. Check package.json for East dependencies
2. If East deps found:
   a. Load pre-built index.json
   b. Initialize MiniSearch with relevant skill sections
   c. Output welcome message listing available skills
3. Exit 0
```

### UserPromptSubmit Hook

```
1. Quick check: does prompt contain East-related keywords?
   - If no: exit 0 immediately (no injection, <10ms)
2. Read package.json to get project East dependencies
3. Load search index (from SessionStart or re-init)
4. Search index with prompt, filtered by relevant skills
5. Format top 3-5 results (max 4000 chars)
6. Output JSON with additionalContext
7. Exit 0
```

### Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     BUILD TIME (CI)                              │
├─────────────────────────────────────────────────────────────────┤
│  reference/*.md  ──►  build-index.mjs  ──►  build/index.json   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     RUNTIME (User's machine)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SessionStart:                                                   │
│    package.json ──► detect deps ──► load index.json             │
│                                          │                       │
│                                          ▼                       │
│                                    MiniSearch (in memory)        │
│                                          │                       │
│  UserPromptSubmit:                       │                       │
│    prompt ──► keyword check ──► search ──┘                      │
│                                    │                             │
│                                    ▼                             │
│                              matched sections                    │
│                                    │                             │
│                                    ▼                             │
│                           additionalContext ──► Claude           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Performance Considerations

1. **SessionStart**: Only runs once per session (or on resume), can take up to 10s
2. **UserPromptSubmit**: Runs on every prompt, must be <500ms for good UX
   - Skip early if not an East project (check cached deps)
   - Use pre-built search index (no parsing at runtime)
   - Limit search results to top 3-5
   - Exit immediately with code 0 and no output if no matches
3. **Truncation**: Keep injected context under 4000 chars to avoid overwhelming Claude
4. **Caching**: Cache project dependencies from SessionStart to avoid re-reading package.json

## Testing Strategy

1. **SessionStart**:
   ```bash
   # Create test project with East deps
   mkdir /tmp/test-east && cd /tmp/test-east
   echo '{"dependencies":{"@elaraai/east":"*"}}' > package.json

   # Build hooks first
   cd /path/to/east-plugin && npm run build:hooks

   # Run hook manually
   CLAUDE_PROJECT_DIR=/tmp/test-east CLAUDE_PLUGIN_ROOT=/path/to/east-plugin \
     node /path/to/east-plugin/hooks/dist/session-start.js
   ```

2. **UserPromptSubmit**:
   ```bash
   # Simulate prompt input
   echo '{"prompt":"How do I create an East function?"}' | \
     CLAUDE_PROJECT_DIR=/tmp/test-east CLAUDE_PLUGIN_ROOT=/path/to/east-plugin \
     node /path/to/east-plugin/hooks/dist/prompt-submit.js
   ```

## Design Decisions

1. **Hook Language: TypeScript (compiled to ES Modules)**
   - East users already have Node.js 22+ installed
   - Type safety and better IDE support
   - Consistent with East project conventions
   - MiniSearch library installed via npm

2. **Multiple Matching Skills: Prioritized List**
   - Search up to 3 most relevant skills based on project deps + prompt keywords
   - Boost skills that match prompt keywords to the front
   - Always include `east` skill as foundation if any East skill matches

3. **PostToolUse: Deferred**
   - Start with SessionStart + UserPromptSubmit hooks
   - Consider adding PostToolUse later for code validation if needed
   - Could be implemented as skill-specific hooks in SKILL.md frontmatter

## Edge Cases and Mitigations

| Edge Case | Mitigation |
|-----------|------------|
| No package.json | Skip doc injection entirely (not an East project) |
| Very long prompt | MiniSearch handles tokenization; no truncation needed |
| No matching sections | Score threshold filters out low-quality matches |
| Multiple skills match equally | Return results from all matching skills, sorted by score |
| Docs are huge | Pre-truncate sections to 2000 chars during indexing |
| User asks non-East question | Low search scores → no injection (no keyword check needed) |
| Hook times out | Set 5s timeout, fail gracefully with no injection |
| Index missing | Rebuild on next CI run; hooks degrade gracefully |

## Final File Structure

```
east-plugin/
├── .claude-plugin/
│   └── plugin.json                   # Plugin manifest
├── hooks/
│   ├── hooks.json                    # Hook configuration
│   ├── src/
│   │   ├── session-start.ts          # Project detection + cache init
│   │   ├── prompt-submit.ts          # Doc search + injection
│   │   └── lib/
│   │       ├── search.ts             # Section parsing and search
│   │       ├── routing.ts            # Skill routing logic
│   │       └── cache.ts              # Cache management
│   ├── dist/                         # Compiled JS (gitignored)
│   └── tsconfig.json                 # TypeScript config for hooks
├── build/
│   └── index.json                    # Pre-built search index (gitignored)
├── skills/
│   ├── east/
│   │   ├── SKILL.md
│   │   └── reference/
│   │       ├── api.md
│   │       └── examples.md
│   ├── east-node-std/
│   │   ├── SKILL.md
│   │   └── reference/
│   │       ├── api.md
│   │       └── examples.md
│   └── ... (other skills)
├── commands/                         # Claude Code slash commands
│   ├── compile.md
│   └── e3-*.md
├── scripts/
│   ├── lib/                          # Shared bash libraries
│   │   ├── common.sh
│   │   └── docker-fallback.sh
│   ├── global/                       # Global install scripts
│   │   ├── install.sh
│   │   ├── install-dev.sh
│   │   ├── update.sh
│   │   └── update-dev.sh
│   ├── project/                      # Project scaffolding
│   │   ├── east.sh                   # AGPL East project
│   │   └── e3.sh                     # BSL e3 project
│   ├── e3/                           # e3 CLI wrappers
│   │   └── *.sh
│   └── east/                         # East CLI wrappers
│       └── compile.sh
├── docker/
│   ├── Dockerfile.east-node
│   ├── Dockerfile.e3
│   ├── install-packages.sh
│   └── test-install.sh
├── tests/                            # Test scripts
│   ├── test-all.sh
│   ├── test-scripts-syntax.sh
│   ├── test-project-east.sh
│   ├── test-project-e3.sh
│   └── test-docker-builds.sh
├── docs/
│   ├── hooks-design.md               # This document
│   └── scripts-design.md             # Scripts reorganization design
├── package.json                      # Dependencies and scripts
├── tsconfig.json                     # Root TypeScript config
├── eslint.config.js                  # ESLint config
└── README.md
```

## hooks/hooks.json

```json
{
  "description": "East plugin hooks for project detection and documentation injection",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup|resume",
        "hooks": [
          {
            "type": "command",
            "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/dist/session-start.js",
            "timeout": 10
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/dist/prompt-submit.js",
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

## TypeScript Configuration

### Root tsconfig.json

```json
{
  "compilerOptions": {
    "rootDir": ".",
    "outDir": "./dist",
    "module": "nodenext",
    "target": "esnext",
    "lib": ["esnext", "es2024"],
    "types": ["node"],
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,
    "strict": true,
    "verbatimModuleSyntax": true,
    "isolatedModules": true,
    "noUncheckedSideEffectImports": true,
    "moduleDetection": "force",
    "skipLibCheck": true,
    "noErrorTruncation": true,
    "incremental": true
  },
  "include": ["scripts/**/*.ts"],
  "exclude": ["node_modules", "dist", "build"]
}
```

### hooks/tsconfig.json

```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "rootDir": "./src",
    "outDir": "./dist"
  },
  "include": ["src/**/*.ts"],
  "exclude": ["dist"]
}
```

## ESLint Configuration

### eslint.config.js

```javascript
import tseslint from '@typescript-eslint/eslint-plugin';
import tsparser from '@typescript-eslint/parser';

export default [
  {
    ignores: ['dist/**', 'build/**', 'node_modules/**', 'hooks/dist/**']
  },
  {
    files: ['**/*.ts'],
    languageOptions: {
      parser: tsparser,
      parserOptions: {
        project: './tsconfig.json'
      }
    },
    plugins: {
      '@typescript-eslint': tseslint
    },
    rules: {
      ...tseslint.configs.recommended.rules,
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-unused-vars': ['error', { 'argsIgnorePattern': '^_', 'varsIgnorePattern': '^_' }],
      '@typescript-eslint/explicit-function-return-type': 'off',
      '@typescript-eslint/no-unnecessary-type-constraint': 'off',
      '@typescript-eslint/no-floating-promises': 'error',
      '@typescript-eslint/require-await': 'error',
      '@typescript-eslint/no-misused-promises': 'error'
    }
  },
  {
    files: ['hooks/src/**/*.ts'],
    languageOptions: {
      parser: tsparser,
      parserOptions: {
        project: './hooks/tsconfig.json'
      }
    }
  }
];
```

## Package Configuration

### package.json

```json
{
  "name": "@elaraai/east-plugin",
  "version": "0.1.0",
  "description": "East plugin for Claude Code",
  "type": "module",
  "engines": {
    "node": ">=22.0.0"
  },
  "scripts": {
    "build": "tsc && tsc -p hooks/tsconfig.json",
    "build:hooks": "tsc -p hooks/tsconfig.json",
    "build:index": "npx tsx scripts/build-index.ts",
    "lint": "eslint .",
    "lint:fix": "eslint . --fix",
    "prepublishOnly": "npm run lint && npm run build"
  },
  "devDependencies": {
    "@types/node": "^22.18.1",
    "@typescript-eslint/eslint-plugin": "^8.42.0",
    "@typescript-eslint/parser": "^8.42.0",
    "eslint": "^9.34.0",
    "minisearch": "^7.1.0",
    "tsx": "^4.19.2",
    "typescript": "~5.9.2"
  }
}
```

## Development Plan

This plan must be executed in order. Phase 1 (documentation overhaul) is a prerequisite for Phase 2 (hooks infrastructure).

### Phase 1: Documentation Overhaul (All Source Repos)

Overhaul SKILL.md, reference docs, and example files across ALL East repositories. This is the foundation for the search index.

#### 1.1 Repository: `east` (Core Language)

**Location**: `github.com/elaraai/east`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure, ensure comprehensive | Package exports, type definitions |
| `reference/types.md` | Create with YAML frontmatter | `src/types/*.ts`, unit tests |
| `reference/types.example.ts` | Testable examples | `tests/types/*.spec.ts` |
| `reference/functions.md` | Create with YAML frontmatter | `src/function.ts`, unit tests |
| `reference/functions.example.ts` | Testable examples | `tests/function/*.spec.ts` |
| `reference/expressions.md` | Create with YAML frontmatter | `src/expressions/*.ts` |
| `reference/expressions.example.ts` | Testable examples | `tests/expressions/*.spec.ts` |
| `reference/compilation.md` | Create with YAML frontmatter | `src/compile.ts` |
| `reference/compilation.example.ts` | Testable examples | `tests/compile/*.spec.ts` |

**Topics to cover:**
- Primitive types: `IntegerType`, `FloatType`, `StringType`, `BooleanType`, `DatetimeType`, `DurationType`
- Collection types: `ArrayType`, `SetType`, `DictType`, `StructType`, `VariantType`, `NullableType`
- Function creation: `East.function`, `East.asyncFunction`, `East.platform`, `East.asyncPlatform`
- BlockBuilder: `$.let`, `$.const`, `$.return`, `$.if`, `$.while`, `$.for`, `$.match`
- Expressions: arithmetic, comparison, logical, string interpolation (`East.str`)
- Compilation: `East.compile`, `.toIR()`, `EastIR.fromJSON()`

#### 1.2 Repository: `east-node` (Node.js Packages)

**Location**: `github.com/elaraai/east-node`

##### Package: `east-node-std`

**Path**: `packages/east-node-std`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure | Package exports |
| `reference/console.md` | Create with YAML frontmatter | `src/console.ts` |
| `reference/console.example.ts` | Testable examples | `tests/console.spec.ts` |
| `reference/filesystem.md` | Create with YAML frontmatter | `src/filesystem.ts` |
| `reference/filesystem.example.ts` | Testable examples | `tests/filesystem.spec.ts` |
| `reference/fetch.md` | Create with YAML frontmatter | `src/fetch.ts` |
| `reference/fetch.example.ts` | Testable examples | `tests/fetch.spec.ts` |
| `reference/crypto.md` | Create with YAML frontmatter | `src/crypto.ts` |
| `reference/crypto.example.ts` | Testable examples | `tests/crypto.spec.ts` |
| `reference/time.md` | Create with YAML frontmatter | `src/time.ts` |
| `reference/time.example.ts` | Testable examples | `tests/time.spec.ts` |
| `reference/path.md` | Create with YAML frontmatter | `src/path.ts` |
| `reference/path.example.ts` | Testable examples | `tests/path.spec.ts` |
| `reference/random.md` | Create with YAML frontmatter | `src/random.ts` |
| `reference/random.example.ts` | Testable examples | `tests/random.spec.ts` |

**Topics to cover:**
- Console: `Console.log`, `Console.warn`, `Console.error`
- FileSystem: `FileSystem.readFile`, `FileSystem.writeFile`, `FileSystem.exists`, `FileSystem.readDir`
- Fetch: `Fetch.get`, `Fetch.post`, `Fetch.put`, `Fetch.delete`
- Crypto: `Crypto.uuid`, `Crypto.hash`, `Crypto.hmac`
- Time: `Time.now`, `Time.sleep`, `Time.format`
- Path: `Path.join`, `Path.dirname`, `Path.basename`, `Path.extname`
- Random: `Random.float`, `Random.integer`, `Random.normal`, `Random.choice`

##### Package: `east-node-io`

**Path**: `packages/east-node-io`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure | Package exports |
| `reference/sql-sqlite.md` | Create with YAML frontmatter | `src/sql/sqlite.ts` |
| `reference/sql-sqlite.example.ts` | Testable examples | `tests/sql/sqlite.spec.ts` |
| `reference/sql-postgres.md` | Create with YAML frontmatter | `src/sql/postgres.ts` |
| `reference/sql-postgres.example.ts` | Testable examples | `tests/sql/postgres.spec.ts` |
| `reference/sql-mysql.md` | Create with YAML frontmatter | `src/sql/mysql.ts` |
| `reference/sql-mysql.example.ts` | Testable examples | `tests/sql/mysql.spec.ts` |
| `reference/nosql-redis.md` | Create with YAML frontmatter | `src/nosql/redis.ts` |
| `reference/nosql-redis.example.ts` | Testable examples | `tests/nosql/redis.spec.ts` |
| `reference/nosql-mongodb.md` | Create with YAML frontmatter | `src/nosql/mongodb.ts` |
| `reference/nosql-mongodb.example.ts` | Testable examples | `tests/nosql/mongodb.spec.ts` |
| `reference/storage-s3.md` | Create with YAML frontmatter | `src/storage/s3.ts` |
| `reference/storage-s3.example.ts` | Testable examples | `tests/storage/s3.spec.ts` |
| `reference/transfer-ftp.md` | Create with YAML frontmatter | `src/transfer/ftp.ts` |
| `reference/transfer-ftp.example.ts` | Testable examples | `tests/transfer/ftp.spec.ts` |
| `reference/transfer-sftp.md` | Create with YAML frontmatter | `src/transfer/sftp.ts` |
| `reference/transfer-sftp.example.ts` | Testable examples | `tests/transfer/sftp.spec.ts` |
| `reference/format-xlsx.md` | Create with YAML frontmatter | `src/format/xlsx.ts` |
| `reference/format-xlsx.example.ts` | Testable examples | `tests/format/xlsx.spec.ts` |
| `reference/format-xml.md` | Create with YAML frontmatter | `src/format/xml.ts` |
| `reference/format-xml.example.ts` | Testable examples | `tests/format/xml.spec.ts` |
| `reference/compression.md` | Create with YAML frontmatter | `src/compression/*.ts` |
| `reference/compression.example.ts` | Testable examples | `tests/compression/*.spec.ts` |

**Topics to cover:**
- SQL: `SQL.SQLite`, `SQL.Postgres`, `SQL.MySQL` - query, execute, transaction
- NoSQL: `NoSQL.Redis`, `NoSQL.MongoDB` - get, set, find, aggregate
- Storage: `Storage.S3` - get, put, list, delete
- Transfer: `Transfer.FTP`, `Transfer.SFTP` - upload, download, list
- Format: `Format.XLSX`, `Format.XML` - parse, serialize
- Compression: `Compression.Gzip`, `Compression.Zip`, `Compression.Tar`

#### 1.3 Repository: `east-py` (Python Packages)

**Location**: `github.com/elaraai/east-py`

##### Package: `east-py-datascience`

**Path**: `packages/east-py-datascience`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure | Package exports |
| `reference/optimization-mads.md` | Create with YAML frontmatter | TypeScript types, Python impl |
| `reference/optimization-mads.example.ts` | Testable examples | Test files |
| `reference/optimization-optuna.md` | Create with YAML frontmatter | TypeScript types |
| `reference/optimization-optuna.example.ts` | Testable examples | Test files |
| `reference/optimization-simanneal.md` | Create with YAML frontmatter | TypeScript types |
| `reference/optimization-simanneal.example.ts` | Testable examples | Test files |
| `reference/optimization-scipy.md` | Create with YAML frontmatter | TypeScript types |
| `reference/optimization-scipy.example.ts` | Testable examples | Test files |
| `reference/ml-xgboost.md` | Create with YAML frontmatter | TypeScript types |
| `reference/ml-xgboost.example.ts` | Testable examples | Test files |
| `reference/ml-lightgbm.md` | Create with YAML frontmatter | TypeScript types |
| `reference/ml-lightgbm.example.ts` | Testable examples | Test files |
| `reference/ml-ngboost.md` | Create with YAML frontmatter | TypeScript types |
| `reference/ml-ngboost.example.ts` | Testable examples | Test files |
| `reference/ml-torch.md` | Create with YAML frontmatter | TypeScript types |
| `reference/ml-torch.example.ts` | Testable examples | Test files |
| `reference/ml-gp.md` | Create with YAML frontmatter | TypeScript types |
| `reference/ml-gp.example.ts` | Testable examples | Test files |
| `reference/sklearn.md` | Create with YAML frontmatter | TypeScript types |
| `reference/sklearn.example.ts` | Testable examples | Test files |
| `reference/shap.md` | Create with YAML frontmatter | TypeScript types |
| `reference/shap.example.ts` | Testable examples | Test files |

**Topics to cover:**
- Optimization: `MADS`, `Optuna`, `SimAnneal`, `Scipy` - minimize, maximize, constraints
- Gradient Boosting: `XGBoost`, `LightGBM` - train, predict, feature importance
- Probabilistic: `NGBoost`, `GP` - uncertainty quantification
- Neural Networks: `Torch.MLP` - train, predict
- Utilities: `Sklearn` - preprocessing, metrics, train/test split
- Explainability: `Shap` - explain predictions

#### 1.4 Repository: `east-ui` (UI Components)

**Location**: `github.com/elaraai/east-ui`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure | Package exports |
| `reference/layout.md` | Create with YAML frontmatter | `src/components/layout/*.ts` |
| `reference/layout.example.ts` | Testable examples | Test files |
| `reference/input.md` | Create with YAML frontmatter | `src/components/input/*.ts` |
| `reference/input.example.ts` | Testable examples | Test files |
| `reference/display.md` | Create with YAML frontmatter | `src/components/display/*.ts` |
| `reference/display.example.ts` | Testable examples | Test files |
| `reference/data.md` | Create with YAML frontmatter | `src/components/data/*.ts` |
| `reference/data.example.ts` | Testable examples | Test files |
| `reference/overlay.md` | Create with YAML frontmatter | `src/components/overlay/*.ts` |
| `reference/overlay.example.ts` | Testable examples | Test files |
| `reference/variants.md` | Create with YAML frontmatter | `src/variants/*.ts` |
| `reference/variants.example.ts` | Testable examples | Test files |

**Topics to cover:**
- Layout: `Stack`, `Box`, `Grid`, `Card`, `Divider`, `Spacer`
- Input: `Input`, `Select`, `Checkbox`, `Switch`, `Slider`, `DatePicker`, `Button`
- Display: `Text`, `Badge`, `Tag`, `Stat`, `Progress`, `Avatar`
- Data: `Table`, `DataList`, `Chart`
- Overlay: `Dialog`, `Drawer`, `Popover`, `Tooltip`, `Menu`
- Variants: `FontWeight`, `TextAlign`, `ColorScheme`, `Size`

#### 1.5 Repository: `e3` (Execution Engine)

**Location**: `github.com/elaraai/e3`

| File | Action | Source of Truth |
|------|--------|-----------------|
| `SKILL.md` | Review structure | Package exports |
| `reference/package.md` | Create with YAML frontmatter | `src/package.ts` |
| `reference/package.example.ts` | Testable examples | Test files |
| `reference/task.md` | Create with YAML frontmatter | `src/task.ts` |
| `reference/task.example.ts` | Testable examples | Test files |
| `reference/input.md` | Create with YAML frontmatter | `src/input.ts` |
| `reference/input.example.ts` | Testable examples | Test files |
| `reference/export.md` | Create with YAML frontmatter | `src/export.ts` |
| `reference/export.example.ts` | Testable examples | Test files |
| `reference/workspace.md` | Create with YAML frontmatter | CLI docs |
| `reference/cli.md` | Create with YAML frontmatter | CLI help |
| `reference/cli.example.ts` | Testable examples | Test files |

**Topics to cover:**
- Package: `e3.package` - define dataflow packages
- Task: `e3.task` - define computational tasks
- Input: `e3.input` - define external inputs
- Export: `e3.export` - define outputs (zip, file, etc.)
- Workspace: initialization, start, watch
- CLI: `e3 init`, `e3 start`, `e3 run`, `e3 watch`, `e3 get`, `e3 set`, `e3 logs`, `e3 status`

### Documentation Standards

#### YAML Frontmatter Format

Every `.md` reference file must have YAML frontmatter:

```markdown
---
title: Array Operations
keywords: [array, ArrayType, sum, map, filter, reduce, forEach, length, slice]
summary: Operations for working with arrays - iteration, transformation, aggregation
examples: [collections.example.ts]
---

## Array Operations
...
```

#### Keyword Guidelines

- **Exact API names**: `East.function`, `$.let`, `ArrayType`, `Console.log`
- **Common synonyms**: `array`/`list`, `dict`/`map`/`object`, `function`/`method`
- **Action verbs**: `sum`, `iterate`, `filter`, `map`, `query`, `fetch`
- **Problem terms**: `aggregate`, `transform`, `process`, `optimize`, `train`

#### Example File Format

Every `.example.ts` file must:

1. Use real imports from the package
2. Export named functions/constants (no default exports)
3. Include comments explaining each example
4. Be compilable with `tsc`

```typescript
// reference/expressions/collections.example.ts
import { East, IntegerType, ArrayType } from "@elaraai/east";

// Example: Sum an array of integers
export const sumArray = East.function(
    [ArrayType(IntegerType)],
    IntegerType,
    ($, arr) => {
        $.return(arr.sum());
    }
);

// Example: Filter positive numbers
export const filterPositive = East.function(
    [ArrayType(IntegerType)],
    ArrayType(IntegerType),
    ($, arr) => {
        $.return(arr.filter(x => x.gt(0n)));
    }
);
```

#### Best Practices

When defining a package's reference markdown and examples, developers should:

1. **Check SKILL.md structure**: Ensure the reference docs align with the high-level API overview in `SKILL.md`. The skill file defines the conceptual organization that reference docs should follow.

2. **Reference unit tests**: Use the package's unit tests as the source of truth for working examples. Tests demonstrate correct API usage and are verified by CI. Copy patterns from test files to ensure examples are accurate.

3. **Verify imports**: Example `.ts` files should use the same import patterns as the package's test files. This ensures examples work with the published package.

4. **Match API signatures**: Cross-reference TypeScript type definitions and JSDoc comments in source code to ensure documented signatures are accurate.

| Reference | Check Against |
|-----------|---------------|
| `reference/*.md` | `SKILL.md` structure and scope |
| `reference/*.example.ts` | Unit test patterns and imports |
| API signatures | Source `.d.ts` files |
| Keywords | Function names, type names, test descriptions |

### Phase 2: Hooks Infrastructure (east-plugin)

**Prerequisites**: Phase 1 complete (all repos have YAML frontmatter and example files)

#### 2.1 Create Hook Scripts

| File | Purpose |
|------|---------|
| `hooks/hooks.json` | Hook configuration |
| `hooks/src/session-start.ts` | Detect East project, init search index, output welcome |
| `hooks/src/prompt-submit.ts` | Full-text search prompt against index, inject results |
| `hooks/src/lib/search.ts` | MiniSearch wrapper, frontmatter parsing |
| `hooks/src/lib/routing.ts` | Map packages to skills |

#### 2.2 Create Index Builder

| File | Purpose |
|------|---------|
| `scripts/build-index.ts` | Build search index from reference docs |

#### 2.3 Update Build Pipeline

- Add `npm run build:index` to `update-skills` workflow
- Add `build/index.json` to `.gitignore`
- Add `minisearch` and `yaml` to dependencies
- TypeScript compilation verifies all `.example.ts` files are valid

### Phase 3: Testing and Validation

#### 3.1 Example Compilation Tests

Add to each source repo's CI:

```yaml
- name: Compile reference examples
  run: |
    cd reference
    npx tsc --noEmit *.example.ts
```

#### 3.2 Hook Integration Tests

```bash
# Test SessionStart hook
mkdir /tmp/test-east && cd /tmp/test-east
echo '{"dependencies":{"@elaraai/east":"*"}}' > package.json
CLAUDE_PROJECT_DIR=/tmp/test-east CLAUDE_PLUGIN_ROOT=/path/to/east-plugin \
  node /path/to/east-plugin/hooks/dist/session-start.js

# Test UserPromptSubmit hook
echo '{"prompt":"How do I sum an array?"}' | \
  CLAUDE_PROJECT_DIR=/tmp/test-east CLAUDE_PLUGIN_ROOT=/path/to/east-plugin \
  node /path/to/east-plugin/hooks/dist/prompt-submit.js
```

#### 3.3 Index Quality Validation

- Verify all packages have documents indexed
- Check keyword coverage matches API surface
- Test search relevance for common queries
